let e,t;console.time("start");try{e=window.supabase.createClient("https://iglmqwpagzjadwauvchh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnbG1xd3BhZ3pqYWR3YXV2Y2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4ODk4NDAsImV4cCI6MjA2NjQ2NTg0MH0.Mtiwp31mJvbLRTotbrb4_DobjjpM4kg9f4-G8oWz85E"),e&&console.log("Supabase客户端初始化成功")}catch(e){ae("系统初始化失败，请刷新页面或联系管理员","error")}const n=document.getElementById("dateRangePicker"),o=document.getElementById("queryBtn"),a=document.getElementById("clearBtn"),l=document.getElementById("summaryTable").querySelector("tbody"),s=document.getElementById("detailTable").querySelector("tbody"),i=document.getElementById("loading"),r=document.getElementById("totalQuantity"),c=document.getElementById("totalAmount"),d=document.getElementById("totalProducts"),u=document.getElementById("totalBrands"),p=(document.getElementById("toggleDetails"),document.getElementById("detailSection")),h=document.getElementById("totalProfit"),m=(document.getElementById("switchWarehouseBtn"),document.getElementById("warehouseSelector")),g=document.getElementById("warehouseOptions"),y=document.getElementById("brandSelector"),f=document.getElementById("brandOptions"),b=document.getElementById("productSelector"),v=document.getElementById("productOptions"),E=document.getElementById("customerSelector"),w=document.getElementById("customerOptions"),C=document.getElementById("authContainer"),q=document.getElementById("appContainer"),L=document.getElementById("loginForm"),_=document.getElementById("registerForm"),x=document.getElementById("loginEmail"),S=document.getElementById("loginPassword"),$=document.getElementById("registerEmail"),k=document.getElementById("registerPassword"),B=document.getElementById("registerPhone"),I=document.getElementById("loginBtn"),M=document.getElementById("registerBtn"),T=document.getElementById("forgotPasswordLink"),D=document.querySelectorAll(".auth-tab"),V=document.getElementById("userStatus"),A=document.getElementById("userInfo"),F=document.getElementById("userName"),H=document.getElementById("userMenu"),O=document.getElementById("logoutBtn");let z,X,P,j,N=[],W=[],R=[],J={},Y=null,G=[],Z=null,Q="default",U=[],K=[],ee="",te="";function ne(e){return"number"!=typeof e?"0":e.toLocaleString("zh-CN",{minimumFractionDigits:0,maximumFractionDigits:2})}function oe(){const e=new Date,n=new Date;1===e.getDate()?(n.setMonth(n.getMonth()-1),n.setDate(1),e.setMonth(e.getMonth()-1),e.setDate(new Date(e.getFullYear(),e.getMonth()+1,0).getDate())):(n.setDate(1),e.setDate(e.getDate()-1)),t.setDate([n,e])}function ae(e,t="error"){const n=document.getElementById("custom-alert");n&&n.remove();const o=document.createElement("div");o.id="custom-alert",o.className=`rounded-alert ${t}`,o.innerHTML=`\n    <div class="alert-content">\n      <i class="fas fa-${"error"===t?"exclamation-circle":"check-circle"}"></i>\n      <span>${e}</span>\n    </div>\n  `,document.body.appendChild(o);const a=o.offsetWidth,l=(window.innerWidth-a)/2;o.style.top="20px",o.style.left=`${l}px`,setTimeout(()=>{o.classList.add("fade-out"),setTimeout(()=>o.remove(),300)},2e3)}function le(){if(p.classList.contains("visible")){p.classList.remove("visible");document.querySelector("#toggleDetails i").classList.replace("fa-chevron-up","fa-chevron-down")}Q="default"===Q?"longqiao":"default";const e=document.querySelector(".filters-row");"longqiao"===Q?e.classList.add("longqiao"):e.classList.remove("longqiao"),function(){const e=document.querySelector("header h1"),t=document.getElementById("profitCard");"longqiao"===Q?(e.innerHTML='<img src="icon64.png" alt="应用图标" style="border-radius: 8px; filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.5));"> 隆桥仓库销售数据查询系统',document.querySelector(".filter-group label:has(i.fas.fa-warehouse)").innerHTML='<i class="fas fa-user"></i> 销售人员',t.style.display="block"):(e.innerHTML='<img src="icon64.png" alt="应用图标" style="border-radius: 8px; filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.5));"> 多多买菜销售数据查询系统',document.querySelector(".filter-group label:has(i.fas.fa-user)").innerHTML='<i class="fas fa-warehouse"></i> 仓库',t.style.display="none");const n=document.getElementById("customerFilterGroup");n&&(n.style.display="longqiao"===Q?"block":"none")}(),he(),oe(),ce().then(()=>{z.reset(),X.reset(),P.reset(),j&&j.reset(),function(){const e=document.querySelector("#detailTable thead");let t=`\n    <tr>\n      <th>日期</th>\n      <th>${"longqiao"===Q?"客户名称":"商品ID"}</th> \n      <th>商品名称</th>\n      <th>品牌</th>\n      <th>${"longqiao"===Q?"销售人员":"仓库"}</th>\n      <th>销量</th>\n      <th>${"longqiao"===Q?"成本":"单价"}</th>\n      <th>金额</th>\n  `;"longqiao"===Q&&(t+="<th>毛利</th>");t+="</tr>",e.innerHTML=t}(),de()})}class se{constructor(e,t,n){this.selector=e,this.optionsContainer=t,this.placeholder=n,this.selectedValues=[],this.allOptions=[],this.clearBtn=e.querySelector(".clear-btn"),this.initEvents()}initEvents(){this.selector.addEventListener("click",e=>this.toggleDropdown(e)),this.clearBtn.addEventListener("click",e=>this.clearSelection(e)),this.optionsContainer.addEventListener("change",e=>this.handleOptionChange(e)),this.optionsContainer.addEventListener("mouseenter",()=>this.optionsContainer.classList.add("active")),this.optionsContainer.addEventListener("mouseleave",()=>this.optionsContainer.classList.remove("active"))}toggleDropdown(e){if(e.target.classList.contains("tag-remove")||e.target.classList.contains("tag")||e.target.closest(".tag-remove")||e.target.closest(".tag"))return;e.stopPropagation(),ie();if(!this.optionsContainer.classList.contains("visible")){this.optionsContainer.classList.add("visible"),Y=this.optionsContainer;this.selector.querySelector(".arrow").classList.replace("fa-chevron-down","fa-chevron-up"),this.positionDropdown()}}positionDropdown(){const e=this.selector.getBoundingClientRect(),t=this.selector.parentElement.getBoundingClientRect();this.optionsContainer.style.width=`${e.width}px`,this.optionsContainer.style.left=e.left-t.left+"px",this.optionsContainer.style.top=e.bottom-t.top+"px"}clearSelection(e){e.stopPropagation(),this.selectedValues=[],this.updateDisplay();this.optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=!1),("brandSelector"===this.selector.id||"productSelector"===this.selector.id)&&(G=[],re())}handleOptionChange(e){if(!e.target.matches('input[type="checkbox"]'))return;const t=e.target,n=t.value;if(t.id.startsWith("selectAll")){const e=this.optionsContainer.querySelectorAll(`input[type="checkbox"]:not([id="${t.id}"])`);t.checked?(this.selectedValues=this.allOptions.map(e=>e.value),e.forEach(e=>e.checked=!0)):(this.selectedValues=[],e.forEach(e=>e.checked=!1))}else{if(t.checked)this.selectedValues.includes(n)||this.selectedValues.push(n);else{const e=this.selectedValues.indexOf(n);e>-1&&this.selectedValues.splice(e,1)}this.updateSelectAllState()}this.updateDisplay(),"brandSelector"===this.selector.id&&(G=[],re(),"longqiao"===Q&&function(){const e=X.selectedValues,t=z.selectedValues;let n=[];n=e.length>0||t.length>0?U.filter(n=>K.some(o=>o.customer===n&&(0===e.length||e.includes(o.brand))&&(0===t.length||t.includes(o.sales)))):U;j.setOptions(n.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),j&&j.reset()}()),"warehouseSelector"===this.selector.id&&function(){if(!K||0===K.length)return;try{let e=[...K];"longqiao"===Q?z.selectedValues.length>0&&(e=e.filter(e=>z.selectedValues.includes(e.sales))):z.selectedValues.length>0&&(e=e.filter(e=>z.selectedValues.includes(e.warehouse)));const t=new Map;if(J={},e.forEach(e=>{e.product_id&&(t.has(e.product_id)||t.set(e.product_id,{product_id:e.product_id,product_name:e.product_name||"未知商品"}),J[e.product_id]=e.brand||"无品牌")}),R=Array.from(t.values()),W=[...new Set(Object.values(J))].sort(),X.setOptions(W.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),re(),"longqiao"===Q){const t=[...new Set(e.map(e=>e.customer).filter(e=>e))].sort();j.setOptions(t.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),j&&j.reset(),X&&X.reset()}}catch(e){ae("重新加载品牌和商品选项失败:",e)}}()}updateDisplay(){const e=this.selector.querySelector(".placeholder"),t=this.selector.querySelector(".selected-display"),n=this.selector.querySelector(".arrow");if(t.innerHTML="",0===this.selectedValues.length)return e.textContent=`全部${this.placeholder}`,e.style.display="block",t.style.display="none",n.style.display="block",n.classList.replace("fa-times","fa-chevron-down"),void(this.clearBtn.style.display="none");e.style.display="none",t.style.display="flex";const o=this.selectedValues.slice(0,5),a=this.selectedValues.length-5;if(o.forEach(e=>{const n=this.allOptions.find(t=>t.value===e);n&&t.insertAdjacentHTML("beforeend",`\n        <div class='tag' data-value='${e}'>\n          ${n.label}\n          <span class='tag-remove'><i class="far fa-circle-xmark"></i></span> \n        </div>\n      `)}),a>0){const e=document.createElement("div");e.className="tag more-tag",e.textContent=`...等${this.selectedValues.length}项`,t.appendChild(e)}n.style.display="none",this.clearBtn.style.display="block"}reset(){this.selectedValues=[],this.updateDisplay();this.optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=!1)}updateSelectAllState(){const e=this.optionsContainer.querySelector('input[id^="selectAll"]');if(e){const t=this.optionsContainer.querySelectorAll('input[type="checkbox"]:not([id^="selectAll"])');e.checked=t.length>0&&Array.from(t).every(e=>e.checked)}}setOptions(e){this.allOptions=e,this.renderOptions(),this.updateDisplay()}renderOptions(){this.optionsContainer.innerHTML="";const e=document.createElement("div");e.className="option",e.innerHTML=`\n      <input type="checkbox" id="selectAll${this.selector.id}">\n      <label for="selectAll${this.selector.id}">全选</label>\n    `,this.optionsContainer.appendChild(e),this.allOptions.forEach(e=>{const t=document.createElement("div");t.className="option",t.innerHTML=`\n        <input type="checkbox" id="${this.selector.id}-${e.value}" \n              value="${e.value}" ${this.selectedValues.includes(e.value)?"checked":""}>\n        <label for="${this.selector.id}-${e.value}">${e.label}</label>\n      `,this.optionsContainer.appendChild(t)})}}function ie(){document.querySelectorAll(".options-container").forEach(e=>{e.classList.remove("visible");const t=e.previousElementSibling.querySelector(".arrow");t&&t.classList.replace("fa-chevron-up","fa-chevron-down")}),Y=null}function re(){v.innerHTML="";const e=document.createElement("div");e.className="option",e.id="productSelectAll",e.innerHTML='\n    <input type="checkbox" id="selectAllProducts">\n    <label for="selectAllProducts">全选</label>\n  ',v.appendChild(e);let t=[],n=X.selectedValues.length;n>0?t=R.filter(e=>J[e.product_id]&&X.selectedValues.includes(J[e.product_id])):(t=R,n="全部"),P.selectedValues=[],t.forEach(e=>{const t=document.createElement("div");t.className="option";const n=P.selectedValues.includes(e.product_id);t.innerHTML=`\n      <input type="checkbox" id="product-${e.product_id}" \n             value="${e.product_id}" ${n?"checked":""}>\n      <label for="product-${e.product_id}">${e.product_name}</label>\n    `,v.appendChild(t)});b.querySelector(".placeholder").textContent=0===X.selectedValues.length?"全部商品":`已筛选${n}个品牌`,P.setOptions(t.map(e=>({value:e.product_id,label:e.product_name})).sort((e,t)=>e.label.localeCompare(t.label)))}async function ce(){try{i.style.display="block",ye();const n=t.selectedDates,o=n[0],a=n[1],l=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;ee=l(o),te=l(a);const s="longqiao"===Q?"longqiao_records":"sales_records",r="longqiao"===Q?["sale_date","product_id","product_name","sales","quantity","customer","amount","cost","brand"]:["sale_date","product_id","product_name","warehouse","quantity","unit_price","brand","pieces"],c={sale_date:{gte:ee,lte:te}};if(console.time("filter-query"),K=await async function(t,n,o={}){if(!e)throw new Error("Supabase客户端未初始化");try{const a=1e4;let l=[],s=0,i=!0,r=e.from(t).select(n.join(","));for(Object.entries(o).forEach(([e,t])=>{Array.isArray(t)?r=r.in(e,t):void 0!==t&&(r="object"==typeof t&&t.gte&&t.lte?r.gte(e,t.gte).lte(e,t.lte):r.eq(e,t))});i;){let e=r.range(s,s+a-1);const{data:t,error:n}=await e;if(n)throw n;t&&t.length>0&&(l=[...l,...t]),i=t.length===a,s+=a}return l}catch(e){throw ae(`从 ${t} 获取数据失败:`,e),e}}(s,r,c),console.timeEnd("filter-query"),K.length>0){const e="longqiao"===Q?"sales":"warehouse";N=[...new Set(K.map(t=>t[e]))].filter(e=>e).sort()}if(J={},K.length>0){const e=new Map;K.forEach(t=>{t.product_id&&!e.has(t.product_id)&&e.set(t.product_id,{product_id:t.product_id,product_name:t.product_name}),t.product_id&&t.brand&&(J[t.product_id]=t.brand)}),R=Array.from(e.values()),W=[...new Set(K.map(e=>e.brand))].filter(e=>e).sort()}return"longqiao"===Q&&K.length>0&&(U=[...new Set(K.map(e=>e.customer))].filter(e=>e).sort()),z=new se(m,g,"longqiao"===Q?"销售人员":"仓库"),X=new se(y,f,"品牌"),P=new se(b,v,"商品"),j=new se(E,w,"客户"),j.setOptions(U.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),z.setOptions(N.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),X.setOptions(W.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),P.setOptions(R.map(e=>({value:e.product_id,label:e.product_name})).sort((e,t)=>e.label.localeCompare(t.label))),"longqiao"===Q&&1===W.length&&setTimeout(()=>{de()},0),Promise.resolve()}catch(e){return ae(`筛选选项加载失败: ${e.message}`,"error"),Promise.reject(e)}finally{i.style.display="none",fe()}}function de(){if(p.classList.contains("visible")){p.classList.remove("visible");document.querySelector("#toggleDetails i").classList.replace("fa-chevron-up","fa-chevron-down")}l.innerHTML="",s.innerHTML="",he();try{let e=K;"longqiao"===Q?z.selectedValues.length>0&&(e=e.filter(e=>z.selectedValues.includes(e.sales))):z.selectedValues.length>0&&(e=e.filter(e=>z.selectedValues.includes(e.warehouse))),X.selectedValues.length>0&&(e=e.filter(e=>X.selectedValues.includes(e.brand))),P.selectedValues.length>0&&(e=e.filter(e=>P.selectedValues.includes(e.product_id))),"longqiao"===Q&&j&&j.selectedValues.length>0&&(e=e.filter(e=>j.selectedValues.includes(e.customer))),function(e){const t=document.getElementById("summaryTable");let n=t.querySelector("thead");n||(n=document.createElement("thead"),t.insertBefore(n,t.firstChild));let o="<tr><th>品牌</th><th>总件数</th><th>总金额</th>";"longqiao"===Q&&(o+="<th>总毛利</th><th>费用发放</th>");o+="</tr>",n.innerHTML=o;let a=t.querySelector("tbody");a||(a=document.createElement("tbody"),t.appendChild(a));if(!e||0===e.length){r.textContent="0",c.textContent="¥0.00",d.textContent="0",u.textContent="0","longqiao"===Q&&(h.textContent="¥0.00");const e="longqiao"===Q?5:3;return void(a.innerHTML=`\n      <tr>\n          <td colspan="${e}" style="text-align: center; padding: 30px; color: #6c757d;">\n          <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n          无汇总数据\n        </td>\n      </tr>\n    `)}let l=0,s=0,i=0,p=0;const m=new Set,g=new Set,y=new Map;e.forEach(e=>{let t,n;if(e.product_id&&g.add(e.product_id),e.brand&&m.add(e.brand),"longqiao"===Q)if(t=e.amount||0,n=e.cost||0,0===t)p+=n;else{const o=e.quantity||0;l+=o,s+=t,i+=t-n}else{const o=e.pieces||0,a=e.quantity||0,i=e.unit_price||0;t=a*i,l+=o,s+=t,n=i}if("longqiao"!==Q||0!==t){const o=e.brand||"未知品牌";y.has(o)||y.set(o,{brand:o,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});const a=y.get(o);"longqiao"===Q?(a.total_quantity+=e.quantity||0,a.total_amount+=t,a.total_cost+=n,a.profit+=t-n):(a.total_quantity+=e.pieces||0,a.total_amount+=t)}if("longqiao"===Q&&0===t){const t=e.brand||"未知品牌";y.has(t)||y.set(t,{brand:t,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});y.get(t).free_issue+=n}});const f="longqiao"===Q&&(1===m.size||1===W.length),b=1===m.size?Array.from(m)[0]:1===W.length?W[0]:null;if(f&&b){const t=new Map;let o=0,l=0,s=0,i=0;const p=new Set;e.forEach(e=>{if(e.brand===b){let n,a;if(e.product_id&&p.add(e.product_id),"longqiao"===Q){n=e.amount||0,a=e.cost||0;const r=e.sales||"未知销售人员";t.has(r)||t.set(r,{sales:r,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});const c=t.get(r);if(0===n)c.free_issue+=a,i+=a;else{const t=e.quantity||0;c.total_quantity+=t,c.total_amount+=n,c.profit+=n-a,o+=t,l+=n,s+=n-a}}}}),r.textContent=ne(o),c.textContent=`¥${ne(l)}`,h.textContent=`¥${ne(s)}`,u.textContent=`¥${ne(i)}`,u.style.color="#e53e3e",d.textContent=ne(p.size);document.querySelectorAll(".stat-card .stat-label")[3].textContent="费用发放",h.style.color=s<=0?"#e53e3e":"#4361ee",n.innerHTML="<tr><th>销售人员</th><th>总件数</th><th>总金额</th><th>总毛利</th><th>费用发放</th></tr>";const m=Array.from(t.values()).sort((e,t)=>t.total_amount-e.total_amount);a.innerHTML="",m.forEach(e=>{const t=document.createElement("tr"),n=e.profit<0?'style="color: #e53e3e; font-weight: bold;"':"";t.innerHTML=`\n          <td>${e.sales}</td>\n          <td>${ne(e.total_quantity)}</td>\n          <td>¥${ne(e.total_amount)}</td>\n          <td ${n}>¥${ne(e.profit)}</td> \n          <td>¥${ne(e.free_issue)}</td> \n      `,a.appendChild(t)}),m.length>0?function(e){const t=document.getElementById("chartContainer");if(t.innerHTML=e.length>0?'<canvas id="brandChart"></canvas>':'<div class="no-chart-data">无销售人员数据可展示</div>',0===e.length)return;const n=document.getElementById("brandChart").getContext("2d");if(!n)return;const o=e=>{const t=["#4BC0C0","#f54444ff","#36A2EB","#F15BB5","#FFCE56","#26cd3cff","#9966FF","#FF9F40","#1982C4","#6A4C93"];if(e>t.length)for(let n=t.length;n<e;n++)t.push(`#${Math.floor(16777215*Math.random()).toString(16)}`);return t.slice(0,e)},a=new Chart(n,{type:"pie",data:{labels:e.map(e=>e.sales),datasets:[{data:e.map(e=>e.total_amount),backgroundColor:o(e.length),borderWidth:1,borderColor:"#fff",hoverOffset:15,radius:"95%"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{size:12,weight:"bold"},padding:15,usePointStyle:!0,color:"#333"}},title:{display:!0,text:"销售人员销售金额占比",font:{size:18,weight:"bold"},color:"#222",padding:{top:20,bottom:15}},tooltip:{backgroundColor:"rgba(0,0,0,0.8)",titleFont:{size:14,weight:"bold"},bodyFont:{size:12},callbacks:{label:function(e){const t=e.label||"",n=e.raw||0,o=e.chart.getDatasetMeta(0).total,a=Math.round(n/o*100);return`${t}: ¥${ne(n)} (${a}%)`}}},datalabels:{display:!0,formatter:(e,t)=>{const n=t.chart.getDatasetMeta(0).total,o=Math.round(e/n*100),a=t.chart.data.labels[t.dataIndex];return o<5?null:`${a}\n${o}%`},color:"#222",font:{weight:"bold",size:window.innerWidth<=768?8:12},align:"end",anchor:"center",offset:0,clip:!1,textAlign:"center",padding:2}},animation:{animateRotate:!0,animateScale:!0}},plugins:[ChartDataLabels]});t.chartInstance=a}(m):he()}else{r.textContent=ne(l),c.textContent=`¥${ne(s)}`;const t=document.querySelectorAll(".stat-card .stat-label");"longqiao"===Q?(u.textContent=`¥${ne(p)}`,u.style.color="#e53e3e",t[3].textContent="费用发放",!(i<=0)||(h.style.color="#e53e3e"),h.textContent=`¥${ne(i)}`):(u.textContent=ne(m.size),u.style.color="",t[3].textContent="品牌数量"),d.textContent=ne(g.size);const n=Array.from(y.values()).sort((e,t)=>t.total_amount-e.total_amount);a.innerHTML="",n.forEach(e=>{const t=document.createElement("tr");let n=`\n          <td>${e.brand}</td>\n          <td>${ne(e.total_quantity)}</td>\n          <td>¥${ne(e.total_amount)}</td>\n      `;if("longqiao"===Q){n+=`\n              <td ${e.profit<0?'style="color: #e53e3e; font-weight: bold;"':""}>¥${ne(e.profit)}</td> \n              <td>¥${ne(e.free_issue)}</td> \n          `}t.innerHTML=n,a.appendChild(t)}),e&&e.length>0?function(e){const t=document.getElementById("chartContainer");if(t.innerHTML=e.length>0?'<canvas id="brandChart"></canvas>':'<div class="no-chart-data">无品牌数据可展示</div>',0===e.length)return;const n=document.getElementById("brandChart").getContext("2d");if(!n)return;const o=e=>{if(baseColors="longqiao"===Q?["#4BC0C0","#f54444ff","#36A2EB","#F15BB5","#FFCE56","#26cd3cff","#9966FF","#FF9F40","#1982C4","#6A4C93"]:["#26cd3cff","#FFCE56","#f54444ff","#36A2EB","#F15BB5","#9966FF","#FF9F40","#6A4C93","#4BC0C0","#1982C4"],e>baseColors.length)for(let t=baseColors.length;t<e;t++)baseColors.push(`#${Math.floor(16777215*Math.random()).toString(16)}`);return baseColors.slice(0,e)},a=new Chart(n,{type:"pie",data:{labels:e.map(e=>e.brand),datasets:[{data:e.map(e=>e.total_amount),backgroundColor:o(e.length),borderWidth:1,borderColor:"#fff",hoverOffset:15,radius:"95%"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{size:12,weight:"bold"},padding:15,usePointStyle:!0,color:"#333"}},title:{display:!0,text:"品牌销售金额占比",font:{size:18,weight:"bold"},color:"#222",padding:{top:20,bottom:15}},tooltip:{backgroundColor:"rgba(0,0,0,0.8)",titleFont:{size:14,weight:"bold"},bodyFont:{size:12},callbacks:{label:function(e){const t=e.label||"",n=e.raw||0,o=e.chart.getDatasetMeta(0).total,a=Math.round(n/o*100);return`${t}: ¥${ne(n)} (${a}%)`}}},datalabels:{display:!0,formatter:(e,t)=>{const n=t.chart.getDatasetMeta(0).total,o=Math.round(e/n*100),a=t.chart.data.labels[t.dataIndex];return o<5?null:`${a}\n${o}%`},color:"#222",font:{weight:"bold",size:window.innerWidth<=768?8:12},align:"end",anchor:"center",offset:0,clip:!1,textAlign:"center",padding:2}},animation:{animateRotate:!0,animateScale:!0}},plugins:[ChartDataLabels]});t.chartInstance=a}(n):he()}setTimeout(()=>{!function(){const e=document.querySelector(".summary-table-container"),t=document.querySelector(".chart-container");if(e&&t){const n=e.offsetHeight;t.style.height=`${n}px`,t.chartInstance&&t.chartInstance.resize()}}()},0)}(e),ue(e,!1)}catch(e){console.error("查询错误详情:",e),i.innerHTML=`\n      <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">\n        <div style="color: #e53e3e; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>\n        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">数据加载失败</p>\n        <p>${e.message}</p>\n      </div>\n    `}}function ue(e,t=!1){const n=document.getElementById("detailCount");e&&0!==e.length?n.textContent=`(${e.length}条)`:n.textContent="(0条数据)",t&&setTimeout(()=>{try{console.time("renderDetailTable");const t=s;if(t.innerHTML="",e&&e.length>0&&e.sort((e,t)=>new Date(t.sale_date)-new Date(e.sale_date)),!e||0===e.length)return void(t.innerHTML=`\n          <tr>\n            <td colspan="${"longqiao"===Q?9:8}" style="text-align: center; padding: 30px; color: #6c757d;">\n              <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n              未找到匹配的记录\n            </td>\n          </tr>\n        `);e.forEach(e=>{const n=document.createElement("tr");let o,a,l;if("longqiao"===Q?(o=e.amount||0,a=e.sales||"--",l=e.cost||0):(o=(e.quantity||0)*(e.unit_price||0),a=e.warehouse||"--",l=e.unit_price||0),n.innerHTML=`\n          <td>${e.sale_date||"--"}</td>\n          <td>${"longqiao"===Q?e.customer||"--":e.product_id||"--"}</td>\n          <td>${e.product_name||"--"}</td>\n          <td>${e.brand||"--"}</td>\n          <td>${a}</td>\n          <td>${ne(e.quantity||0)}</td>\n          <td>${l}</td>\n          <td>¥${ne(o)}</td>\n        `,"longqiao"===Q){const t=(e.amount||0)-(e.cost||0),o=t<0?'style="color: #e53e3e; font-weight: bold;"':"";n.innerHTML+=`<td ${o}>¥${ne(t)}</td>`}t.appendChild(n)}),console.timeEnd("renderDetailTable")}catch(e){console.error("渲染详细表格时出错:",e),s.innerHTML=`\n        <tr>\n          <td colspan="${"longqiao"===Q?9:8}" style="text-align: center; padding: 30px; color: #e53e3e;">\n            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n            <p>渲染表格时发生错误</p>\n          </td>\n        </tr>\n      `}},0)}function pe(){let e=K;return"longqiao"===Q?z.selectedValues.length>0&&(e=e.filter(e=>z.selectedValues.includes(e.sales))):z.selectedValues.length>0&&(e=e.filter(e=>z.selectedValues.includes(e.warehouse))),X.selectedValues.length>0&&(e=e.filter(e=>X.selectedValues.includes(e.brand))),P.selectedValues.length>0&&(e=e.filter(e=>P.selectedValues.includes(e.product_id))),"longqiao"===Q&&j&&j.selectedValues.length>0&&(e=e.filter(e=>j.selectedValues.includes(e.customer))),e}function he(){const e=document.getElementById("chartContainer");e.innerHTML='<div class="no-chart-data">无品牌数据可展示</div>',e.chartInstance&&(e.chartInstance.destroy(),e.chartInstance=null)}function me(){z.reset(),X.reset(),P.reset(),j&&j.reset(),re(),he(),oe(),ce().then(()=>{de()})}function ge(){p.classList.toggle("visible");const e=document.querySelector("#toggleDetails i");p.classList.contains("visible")?(e.classList.replace("fa-chevron-down","fa-chevron-up"),i&&(i.style.display="block",ye()),p.classList.contains("visible")?(ue(pe(),!0),setTimeout(()=>{i&&(i.style.display="none",fe())},300)):i&&(i.style.display="none",fe())):(e.classList.replace("fa-chevron-up","fa-chevron-down"),s&&(s.innerHTML=""))}function ye(){let e=document.getElementById("loading-overlay");e?e.style.display="flex":(e=document.createElement("div"),e.id="loading-overlay",e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(255, 255, 255, 0.2);\n      z-index: 999;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      backdrop-filter: blur(2px);\n    ",document.body.appendChild(e))}function fe(){const e=document.getElementById("loading-overlay");e&&(e.style.display="none")}async function be(){if(/MicroMessenger/i.test(navigator.userAgent))ae("微信浏览器不支持此功能，请在浏览器中打开网页导出数据。","warning");else{if("undefined"==typeof XLSX)try{if(await async function(){try{const e=document.createElement("script");return e.src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",new Promise((t,n)=>{e.onload=()=>t(window.XLSX),e.onerror=()=>n(new Error("XLSX库加载失败")),document.head.appendChild(e)})}catch(e){return ae(`数据导出错误：${e}`,"error"),null}}(),!window.XLSX)throw new Error("XLSX库加载失败")}catch(e){return void ae("导出功能暂时不可用。")}try{const e=pe();if(!e||0===e.length)return void ae("没有数据可导出","warning");const t=XLSX.utils.book_new(),n=e.map(e=>{let t,n,o;"longqiao"===Q?(t=e.amount||0,n=e.sales||"--",o=e.cost||0):(t=(e.quantity||0)*(e.unit_price||0),n=e.warehouse||"--",o=e.unit_price||0);const a={"日期":e.sale_date||"--"};if("longqiao"===Q?a["客户名称"]=e.customer||"--":a["商品ID"]=e.product_id||"--",a["商品名称"]=e.product_name||"--",a["品牌"]=e.brand||"--","longqiao"===Q?a["销售人员"]=n:a["仓库"]=n,a["销量"]=e.quantity||0,"longqiao"===Q?a["成本"]=o:a["单价"]=o,a["金额"]=t,"longqiao"===Q){const t=(e.amount||0)-(e.cost||0);a["毛利"]=t}return a}),o=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(t,o,"销售记录");const a=`${"longqiao"===Q?"隆桥仓库":"多多买菜"}_销售记录_${ee}_${te}.xlsx`;XLSX.writeFile(t,a),ae("数据导出成功","success")}catch(e){ae(`导出失败: ${e.message}`,"error")}}}function ve(){let e;t=flatpickr(n,{mode:"range",dateFormat:"Y-m-d",static:!0,onChange:function(e){2===e.length&&l()}}),t&&oe();const l=()=>{clearTimeout(e),e=setTimeout(()=>{ce().then(()=>{de()}).catch(console.error)},500)};ce().then(()=>{o.addEventListener("click",de),a.addEventListener("click",me),document.getElementById("toggleDetails").addEventListener("click",ge),document.getElementById("exportDetails").addEventListener("click",be),de(),console.timeEnd("start")}).catch(e=>{console.error("初始化失败:",e),i.innerHTML=`\n        <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">\n          <div style="color: #e53e3e; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>\n          <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">初始化失败</p>\n          <p>${e.message}</p>\n        </div>\n      `,i.style.display="block"}),document.addEventListener("click",e=>{m.contains(e.target)||g.contains(e.target)||y.contains(e.target)||f.contains(e.target)||b.contains(e.target)||v.contains(e.target)||E.contains(e.target)||w.contains(e.target)||ie()},!0),document.querySelectorAll(".select-box").forEach(e=>{e.addEventListener("click",t=>{const n=t.target.closest(".tag-remove");if(!n)return;t.stopPropagation(),t.preventDefault();const o=n.closest(".tag"),a=e.id,l=o.dataset.value;if("warehouseSelector"===a){const e=g.querySelector(`input[value="${l}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("brandSelector"===a){const e=f.querySelector(`input[value="${l}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("productSelector"===a){const e=v.querySelector(`input[value="${l}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("customerSelector"===a){const e=w.querySelector(`input[value="${l}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}})}),window.addEventListener("scroll",()=>{ie()}),window.addEventListener("resize",()=>{if(Y){const e=Y.previousElementSibling;e&&("warehouseSelector"===e.id?z.positionDropdown():"brandSelector"===e.id?X.positionDropdown():"productSelector"===e.id?P.positionDropdown():"customerSelector"===e.id&&j.positionDropdown())}})}document.addEventListener("DOMContentLoaded",async()=>{if(!e)return ae("错误: Supabase客户端未正确初始化"),o.disabled=!0,o.textContent="系统未初始化",o.style.background="#e53e3e",o.style.cursor="not-allowed",i.innerHTML='<p style="color: #e53e3e; padding: 1rem;">系统初始化失败，请刷新页面</p>',void(i.style.display="block");const t=await async function(){if(!e)return!1;try{const{data:{user:t},error:n}=await e.auth.getUser();if(t){Z=t;const e=t.email.split("@")[0],n={162004332:"系统管理员",rickyone:"数据管理员",13762405681:"王英",ksf2025:"康师傅",pepsi_cola:"百事可乐",coca_cola:"可口可乐",15096086678:"娟子"}[e]||e;return F.textContent=n,V.style.display="block",C.style.display="none",q.style.display="block",ae(`欢迎${n}！`,"success"),!0}return V.style.display="none",C.style.display="block",!1}catch(e){return ae("用户认证发生错误:",e),!1}}();document.getElementById("switchWarehouseBtn").addEventListener("click",le),function(){A&&A.addEventListener("click",e=>{e.stopPropagation(),H.style.display="block"===H.style.display?"none":"block"});document.addEventListener("click",e=>{H&&"block"===H.style.display&&!A.contains(e.target)&&(H.style.display="none")}),O&&O.addEventListener("click",async()=>{try{const{error:t}=await e.auth.signOut();if(t)return void ae(`退出登录失败: ${t.message}`,"error");ae("已成功退出登录","success"),setTimeout(()=>{window.location.reload()},500)}catch(e){ae("退出登录时发生错误","error")}})}(),t?ve():(D.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");D.forEach(e=>e.classList.remove("active")),e.classList.add("active"),L.classList.remove("active"),_.classList.remove("active"),"login"===t?(L.classList.add("active"),L.style.display="block",_.style.display="none"):(_.classList.add("active"),_.style.display="block",L.style.display="none")})}),I.addEventListener("click",async()=>{const t=x.value,n=S.value;if(!t||!n)return void ae("请输入邮箱和密码","warning");const{data:o,error:a}=await e.auth.signInWithPassword({email:t,password:n});if(ae("登录成功！","success"),a)return void ae("登录失败: 请检查用户名或密码是否正确！","error");Z=o.user;const l=Z.email.split("@")[0],s={162004332:"系统管理员",rickyone:"数据管理员",13762405681:"王英",ksf2025:"康师傅",pepsi_cola:"百事可乐",coca_cola:"可口可乐",15096086678:"娟子"}[l]||l;F.textContent=s,V.style.display="block",C.style.display="none",q.style.display="block",ae(`欢迎${s}！`,"success"),ve()}),S&&S.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),I.click())}),M.addEventListener("click",async()=>{const t=$.value,n=k.value,o=B.value;if(!t||!n)return void ae("请输入邮箱和密码","warning");const a={email:t,password:n,options:{data:{}}};o&&(a.phone=o);try{const{data:n,error:o}=await e.auth.signUp(a);if(o)return void ae("注册失败: 该功能被禁止，请与管理员联系！","error");ae("注册成功! 请检查您的邮箱进行验证","success"),D.forEach(e=>e.classList.remove("active")),document.querySelector('.auth-tab[data-tab="login"]').classList.add("active"),L.classList.add("active"),L.style.display="block",_.style.display="none",x.value=t}catch(e){ae(`注册异常: ${e.message}`,"error")}}),T.addEventListener("click",async t=>{t.preventDefault();const n=x.value;if(!n)return void ae("请输入您的邮箱","warning");const{data:o,error:a}=await e.auth.resetPasswordForEmail(n,{redirectTo:window.location.href});a?ae(`发送重置邮件失败: ${a.message}`,"error"):ae("密码重置邮件已发送，请检查您的邮箱","success")}))});