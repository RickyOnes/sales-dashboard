<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>销售数据查询系统</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; line-height: 1.6; color: #333; background-color: #f8f9fa; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    header { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 2rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .subtitle { font-size: 1.1rem; opacity: 0.9; }
    .card { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; overflow: hidden; }
    .card-header { padding: 1.5rem; background-color: #f1f5f9; border-bottom: 1px solid #e2e8f0; }
    .card-body { padding: 1.5rem; }
    .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .filter-group { display: flex; flex-direction: column; }
    label { font-weight: 600; margin-bottom: 0.5rem; color: #4a5568; }
    input, select { padding: 0.75rem; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 1rem; }
    button { background: #4299e1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; }
    button:hover { background: #3182ce; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(50, 115, 220, 0.3); }
    .btn-query { background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%); }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background-color: #f7fafc; font-weight: 600; color: #4a5568; }
    tr:hover { background-color: #f8fafc; }
    .summary-card { background: linear-gradient(135deg, #dbeafe 0%, #d1fae5 100%); }
    .loading { display: none; text-align: center; padding: 2rem; }
    .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4299e1; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .chart-container { height: 300px; margin-top: 2rem; }
    @media (max-width: 768px) {
      .filters { grid-template-columns: 1fr; }
      header { padding: 1.5rem; }
      h1 { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>销售数据查询系统</h1>
      <p class="subtitle">实时查看和分析销售数据</p>
    </header>
    
    <div class="card">
      <div class="card-header">
        <h2>数据筛选</h2>
      </div>
      <div class="card-body">
        <div class="filters">
          <div class="filter-group">
            <label for="startDate">开始日期</label>
            <input type="date" id="startDate">
          </div>
          
          <div class="filter-group">
            <label for="endDate">结束日期</label>
            <input type="date" id="endDate">
          </div>
          
          <div class="filter-group">
            <label for="warehouse">仓库</label>
            <select id="warehouse">
              <option value="">全部仓库</option>
              <!-- 仓库选项将通过JS动态添加 -->
            </select>
          </div>
          
          <div class="filter-group">
            <label for="product">商品</label>
            <select id="product">
              <option value="">全部商品</option>
              <!-- 商品选项将通过JS动态添加 -->
            </select>
          </div>
        </div>
        
        <button id="queryBtn" class="btn-query">查询数据</button>
      </div>
    </div>
    
    <div class="card summary-card">
      <div class="card-header">
        <h2>销售汇总</h2>
      </div>
      <div class="card-body">
        <div class="summary-stats">
          <div style="display: flex; justify-content: space-around; text-align: center; margin-bottom: 1.5rem;">
            <div>
              <div class="stat-label">总销量</div>
              <div id="totalQuantity" class="stat-value">0</div>
            </div>
            <div>
              <div class="stat-label">总金额</div>
              <div id="totalAmount" class="stat-value">¥0.00</div>
            </div>
            <div>
              <div class="stat-label">商品种类</div>
              <div id="totalProducts" class="stat-value">0</div>
            </div>
          </div>
        </div>
        
        <table id="summaryTable">
          <thead>
            <tr>
              <th>商品ID</th>
              <th>商品名称</th>
              <th>仓库</th>
              <th>销量</th>
              <th>金额</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h2>详细销售记录</h2>
      </div>
      <div class="card-body">
        <table id="detailTable">
          <thead>
            <tr>
              <th>日期</th>
              <th>商品ID</th>
              <th>商品名称</th>
              <th>仓库</th>
              <th>销量</th>
              <th>金额</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>正在加载数据...</p>
    </div>
  </div>

  <script>
      // 1. 初始化Supabase客户端 - 修复命名冲突问题
      const SUPABASE_URL = 'https://iglmqwpagzjadwauvchh.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnbG1xd3BhZ3pqYWR3YXV2Y2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4ODk4NDAsImV4cCI6MjA2NjQ2NTg0MH0.Mtiwp31mJvbLRTotbrb4_DobjjpM4kg9f4-G8oWz85E';
      
      let supabaseClient;  // 使用不同的变量名避免冲突
      
      try {
        // 确保通过window对象访问supabase
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase客户端初始化成功');
      } catch (error) {
        console.error('Supabase初始化失败:', error);
        alert('系统初始化失败，请刷新页面或联系管理员');
      }

      // 2. DOM元素引用
      const startDateEl = document.getElementById('startDate');
      const endDateEl = document.getElementById('endDate');
      const warehouseEl = document.getElementById('warehouse');
      const productEl = document.getElementById('product');
      const queryBtn = document.getElementById('queryBtn');
      const summaryTable = document.getElementById('summaryTable').querySelector('tbody');
      const detailTable = document.getElementById('detailTable').querySelector('tbody');
      const loadingEl = document.getElementById('loading');
      const totalQuantityEl = document.getElementById('totalQuantity');
      const totalAmountEl = document.getElementById('totalAmount');
      const totalProductsEl = document.getElementById('totalProducts');

      // 3. 功能函数
      function setDefaultDates() {
        // 修复日期格式兼容性问题（Safari等浏览器）
        const formatDate = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        };

        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 30);
        
        endDateEl.value = formatDate(endDate);
        startDateEl.value = formatDate(startDate);
      }

      async function loadFilterOptions() {
        if (!supabaseClient) {
          console.error('错误: Supabase客户端未初始化');
          return;
        }
        
        try {
          // 获取仓库列表 - 使用中文表名和字段名
          const { data: warehouses, error: whError } = await supabaseClient
            .from('销售记录') // 中文表名
            .select('仓库')   // 中文字段名
            .not('仓库', 'is', null); // 中文字段名
            
          if (whError) throw whError;
          
          // 去重并排序
          const uniqueWarehouses = [...new Set(warehouses.map(w => w.仓库))].sort(); // 注意字段名改为中文
          
          // 添加到选择框
          warehouseEl.innerHTML = '<option value="">全部仓库</option>';
          uniqueWarehouses.forEach(wh => {
            const option = document.createElement('option');
            option.value = wh;
            option.textContent = wh;
            warehouseEl.appendChild(option);
          });
          
          // 获取商品列表 - 使用中文表名和字段名
          const { data: products, error: pError } = await supabaseClient
            .from('销售记录') // 中文表名
            .select('商品ID, 商品名称') // 中文字段名
            .not('商品ID', 'is', null); // 中文字段名
            
          if (pError) throw pError;
          
          // 去重
          const uniqueProducts = products.filter((p, i, self) => 
            i === self.findIndex(t => t.商品ID === p.商品ID) // 注意字段名改为中文
          ).sort((a, b) => a.商品名称.localeCompare(b.商品名称)); // 注意字段名改为中文
          
          // 添加到选择框
          productEl.innerHTML = '<option value="">全部商品</option>';
          uniqueProducts.forEach(p => {
            const option = document.createElement('option');
            option.value = p.商品ID; // 注意字段名改为中文
            option.textContent = p.商品名称; // 注意字段名改为中文
            productEl.appendChild(option);
          });
          
        } catch (error) {
          console.error('加载筛选选项失败:', error);
          alert('筛选选项加载失败: ' + error.message);
        }
      }

      async function loadData() {
        if (!supabaseClient) {
          alert('系统未初始化，请刷新页面');
          return;
        }
        
        loadingEl.style.display = 'block';
        summaryTable.innerHTML = '';
        detailTable.innerHTML = '';
        
        const startDate = startDateEl.value;
        const endDate = endDateEl.value;
        const warehouse = warehouseEl.value;
        const product = productEl.value;
        
        try {
          // 查询使用中文表名和字段名
          let query = supabaseClient
            .from('销售记录')  // 使用中文表名
            .select('销售日期, 商品ID, 商品名称, 仓库, 销量, 单价') // 使用中文字段名
            .gte('销售日期', startDate)
            .lte('销售日期', endDate);
            
          if (warehouse) query = query.eq('仓库', warehouse);
          if (product) query = query.eq('商品ID', product);
          
          const { data, error } = await query;
          
          if (error) throw error;
          
          // 将中文字段名转换为英文别名以便后续处理
          const transformedData = data.map(item => ({
            sale_date: item.销售日期,
            product_id: item.商品ID,
            product_name: item.商品名称,
            warehouse: item.仓库,
            quantity: item.销量,
            price: item.单价
          }));
          
          renderDetailTable(transformedData);
          calculateSummary(transformedData);
          
        } catch (error) {
          console.error('查询错误详情:', {
            message: error.message,
            details: error.details,
            code: error.code
          });
          // 在加载区域显示错误信息
          loadingEl.innerHTML = `
            <div style="color: #e53e3e;">
              <p>数据加载失败</p>
              <p>错误: ${error.message}</p>
            </div>
          `;
        } finally {
          setTimeout(() => {
            loadingEl.style.display = 'none';
            // 重置加载动画
            loadingEl.innerHTML = '<div class="spinner"></div><p>正在加载数据...</p>';
          }, 2000);
        }
      }

      function renderDetailTable(data) {
        const tbody = detailTable;
        tbody.innerHTML = '';
        
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">未找到匹配的记录</td></tr>';
          return;
        }
        
        data.forEach(record => {
          const row = document.createElement('tr');
          // 前端计算金额 = 销量 × 单价
          const amount = (record.quantity || 0) * (record.price || 0);
          
          row.innerHTML = `
            <td>${record.sale_date || '--'}</td>
            <td>${record.product_id || '--'}</td>
            <td>${record.product_name || '--'}</td>
            <td>${record.warehouse || '--'}</td>
            <td>${record.quantity || 0}</td>
            <td>¥${amount.toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        });
      }

      function calculateSummary(data) {
        if (!data || data.length === 0) {
          totalQuantityEl.textContent = '0';
          totalAmountEl.textContent = '¥0.00';
          totalProductsEl.textContent = '0';
          return;
        }
        
        // 计算总销量和总金额（前端计算）
        let totalQuantity = 0;
        let totalAmount = 0;
        
        data.forEach(record => {
          totalQuantity += record.quantity || 0;
          totalAmount += (record.quantity || 0) * (record.price || 0);
        });
        
        // 更新统计卡片
        totalQuantityEl.textContent = totalQuantity.toLocaleString();
        totalAmountEl.textContent = `¥${totalAmount.toFixed(2)}`;
        
        // 按商品汇总
        const summaryMap = new Map();
        
        data.forEach(record => {
          const key = `${record.product_id}-${record.warehouse}`;
          
          if (!summaryMap.has(key)) {
            summaryMap.set(key, {
              product_id: record.product_id,
              product_name: record.product_name,
              warehouse: record.warehouse,
              total_quantity: 0,
              total_amount: 0
            });
          }
          
          const summary = summaryMap.get(key);
          summary.total_quantity += (record.quantity || 0);
          // 前端计算金额
          summary.total_amount += (record.quantity || 0) * (record.price || 0);
        });
        
        // 更新商品种类数量
        totalProductsEl.textContent = summaryMap.size;
        
        // 渲染汇总表格
        summaryTable.innerHTML = '';
        
        if (summaryMap.size === 0) {
          summaryTable.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">无汇总数据</td></tr>';
          return;
        }
        
        summaryMap.forEach(summary => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${summary.product_id || '--'}</td>
            <td>${summary.product_name || '--'}</td>
            <td>${summary.warehouse || '--'}</td>
            <td>${summary.total_quantity.toLocaleString()}</td>
            <td>¥${summary.total_amount.toFixed(2)}</td>
          `;
          summaryTable.appendChild(row);
        });
      }

      // 4. 页面初始化
      document.addEventListener('DOMContentLoaded', () => {
        if (!supabaseClient) {
          console.error('错误: Supabase客户端未正确初始化');
          // 禁用查询按钮并显示错误状态
          queryBtn.disabled = true;
          queryBtn.textContent = '系统未初始化';
          queryBtn.style.background = '#e53e3e';
          queryBtn.style.cursor = 'not-allowed';
          // 显示错误信息
          loadingEl.innerHTML = '<p style="color: #e53e3e;">系统初始化失败，请刷新页面</p>';
          loadingEl.style.display = 'block';
          return;
        }
        
        console.log('DOM已加载，开始初始化页面');
        
        setDefaultDates();
        loadFilterOptions();
        
        queryBtn.addEventListener('click', loadData);
        
        // 延迟加载初始数据
        setTimeout(() => {
          try {
            loadData();
          } catch (e) {
            console.error('初始数据加载失败:', e);
            loadingEl.innerHTML = '<p style="color: #e53e3e;">初始数据加载失败: ' + e.message + '</p>';
          }
        }, 1000);
      });

  </script>
</body>
</html>